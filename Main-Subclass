/*	-WHAT IS THIS?-
	This file adds optional material to "MPMB's Character Record Sheet" found at https://flapkan.com/mpmb/charsheets
	Import this file using the "Add Extra Materials" bookmark.
	-KEEP IN MIND-
	It is recommended to enter the code in a fresh sheet before adding any other information (i.e. before making your character with it).
*/

/*  -INFORMATION-
	Subject:    Artificer Specialization: Arcane Machinist
	Effect:     Adds the Artificer Specialization Arcane Machinist as a selectable subclass
	Code by:	u/DeathCell593
    Author:     DeathCell593
	Date:		2023-08-08 (sheet v13.1.17)
*/

var iFileName = "Artificer Specialization - Arcane Machinist by [Your Name].js";

if (sheetVersion < 13001007) {
  throw "This script was made for a newer version of the sheet (v13.1.7). Please use the latest version and try again.\nYou can get the latest version at www.flapkan.com.";
}

var iFileName = "all_WotC_pub+UA.js";
RequiredSheetVersion("13.1.7");

SourceList["NB2:AM"] = {
  name: "Artificer Specialization: Arcane Machinist",
  abbreviation: "DC:AM",
  group: "Homebrew",
  date: "2023/08/08",
};

var arcaneMachinistSubclassObj = {
  regExpSearch: /^(?=.*arcane)(?=.*machinist).*$/i,
  subname: "Arcane Machinist",
  fullname: "Arcane Machinist",
  source: ["DC:AM", 1],
  features: {
    "subclassfeature3": {
      name: "Tool proficiency",
      source: ["DC:AM", 1],
      minlevel: 3,
      description: "Proficient with Tinker's tools",
      toolProf: ["Tinker's tools"],
      spellcastingExtra: ["shield", "identify", "heat metal", "shatter", "fireball", "glyph of warding", "fabricate", "dimention door", "wall of force", "bigby's hand"],
    },
    "subclassfeature3.1": {
      name: "Arcane Construct Companion",
      source: ["DC:AM", 1],
      minlevel: 3,
      description: "Starting at 3rd level, you learn how to create an arcane construct companion. This companion aids you in combat and other tasks, growing in power as you do. At level 5, 9, and 15, it will increase in power, unlocking new abilities and things to aid you in all scenarios."
    },
    "subclassfeature5": {
      name: "Arcane Runes",
      source: ["DC:AM", 1],
      minlevel: 5,
      description: "At 5th level, you learn how to inscribe arcane runes on your constructs, enhancing their abilities. Your constructs gain advantage on saving throws against spells and other magical effects."
    },
    "subclassfeature9": {
      name: "Enhanced Arcenal",
      source: ["DC:AM", 1],
      minlevel: 9,
      description: "All Arcane Construct actions gain an aditional die to their rolls."
    },
    "subclassfeature9.1": {
      name: "Self-Destruct",
      source: ["DC:AM", 1],
      minlevel: 9,
      description: "At 9th level, your constructs gain the ability to self-destruct. As an action, your construct can self-destruct, causing an explosion in a 20-foot radius. Each creature in that area must make a Dexterity saving throw against a DC of 8 + your proficiency bonus + your Intelligence modifier, taking 3d8 force damage on a failed save, or half as much damage on a successful one. After using this ability, the construct is destroyed."
    },
    "subclassfeature9.2": {
      name: "Arcane Overdrive",
      source: ["DC:AM", 1],
      minlevel: 9,
      description: "At 9th level, your constructs gain the ability to enter Arcane Overdrive. As a bonus action, you can expend a spell slot to activate this ability. While in Arcane Overdrive, your constructs can perform Arcane Overdrive actions by consuming a spell slot."
    },
    "subclassfeature15": {
      name: "Masterwork Construct",
      source: ["DC:AM", 1],
      minlevel: 15,
      description: "At 15th level, your Arcane Construct reachis its peak. It gains an extra die to all rolls for all actions"
    },
    "subclassfeature15.1": {
      name: "Arcane Reverb",
      source: ["DC:AM", 1],
      minlevel: 15,
      description: "Your construct gains a second attack, allowing for even more versitility in combat."
    },
    "subclassfeature15.2": {
      name: "Automatic Reconstruction",
      source: ["DC:AM", 1],
      minlevel: 15,
      description: "Once per long rest, and after 3 turns, your construct can revive from the dead."
    }
  }
};

// Adding Arcane Machinist subclass to the character sheet
AddSubClass("artificer", "arcane machinist", arcaneMachinistSubclassObj);

// Adding player actions for Arcane Construct's abilities
AddAction("Construct - Repulsion Field", {
  name: "Repulsion Field",
  description: "Str save, DC 12, range 10-ft radius, 1d10 force damage, pushes 10 ft on fail (half damage and no push on success)",
  tooltip: "Str save, DC 12, range 10-ft radius, 1d10 force damage, pushes 10 ft on fail (half damage and no push on success)",
});

AddAction("Construct - Healing Station", {
  name: "Healing Station",
  description: "Restores 2d6 HP to allies within 10-ft radius",
  tooltip: "Restores 2d6 HP to allies within 10-ft radius",
});

AddAction("Construct - Protector", {
  name: "Protector",
  description: "Grants 1d8 + PB temp HP to self and one ally within 30 ft",
  tooltip: "Grants 1d8 + PB temp HP to self and one ally within 30 ft",
});

AddAction("Construct - Self-Destruct", {
  name: "Self-Destruct",
  description: "Dex save, DC 8 + PB + Int mod, range 20-ft radius, 3d8 force damage (half on save), destroys construct",
  tooltip: "Dex save, DC 8 + PB + Int mod, range 20-ft radius, 3d8 force damage (half on save), destroys construct",
});

AddAction("Construct - Arcane Overdrive", {
  name: "Arcane Overdrive",
  description: "Consumes spell slot to activate Evolved Actions",
  tooltip: "Consumes spell slot to activate Evolved Actions",
});
CreatureList["arcane construct"] = {
  name: "Arcane Construct",
	nameMenu : "Companion (Arcane Machinist class feature)",
	nameTooltip : "the Arcane Machinist Companion class feature",
  source: ["DC:AM", 1],
	defaultExcluded : false,
  size: 4, // Small
  type: "Construct",
  alignment: "Neutral",
  ac: 18, // 15 + 3
  hp: 7 + (7 * 3), 
	calcChanges : {
    hp : function (totalHD, HDobj, prefix) {
      if (!classes.known.artificer) return;
			var intMod = Number(What('Int Mod'));
			var artLvl = classes.known.artificer.level;
			HDobj.alt.push(1 + intMod + artLvl);
			HDobj.altStr.push(" = 1 as a base\n + " + intMod + " from its creator's Intelligence modifier\n + " + artLvl + " from its creator's artificer level");
			}},
						setAltHp : true,
						hpForceRecalc : true,
  hd: ["artLvl", "8"],
	hdLinked : ["artificer", "8"],
  speed: "30 ft, Fly 30 ft (Hover)",
  challengeRating : "1",
  scores: [10, 14, 16, 10, 12, 7],
	attacks : [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2],
  saves: ["", 4, 5, "", 3, ""],
  skills:{
 "perception": 3,
 "stealth": 4,
  },
  senses: "darkvision 60 ft.",
  passivePerception: 10,
  proficiencyBonus: 2,
  proficiencyBodusLinked: true,
  attacksAction: 1,
  damage_immunities : "Poison, Psychic",
  damage_resistances : "Bludgeoning, Piercing, and Slashing from non-magical attacks",
  condition_immunities : "Charmed, Frightened, Paralyzed, Petrified, Exhausted, Poisoned",
  languages : "Understands the same languages you, but cant speak",
  traits:[{
     name: "Channel Magic", 
     description: "The Arcane Construct delivers a spell you cast that has a range of touch. The Arcane Construct must be within 120 feet of you.",
}, {
    name: "Evasion", 
    description: "If the Arcane Construct is subjected to an effect that allows it to make a Dexterity saving throw to take only half damage, it instead takes no damage if it succeeds on the saving throw, and only half damage if it fails. It can't use this trait if it's incapacitated.",
}, {
    name: "Cooldown System",
    description: "The Arcane Construct possesses a cooldown system that governs the usage of its abilities. Each ability has a cooldown period, represented by a number of rounds, during which it cannot be used again after being activated. More detail in notes."
  }],
  notes: [{
    name: "Cooldown System continued",
    description: "When an ability is activated, its cooldown period begins. The Arcane Construct cannot use that ability again until the cooldown period elapses. The cooldown period is tracked separately for each ability.",
}, {
    name: "Cooldowns",
    description: "",
}, {
    name: "Tier 0 (no power): 0 turns",
    description: "Force Ballista, Protector.",
}, {
    name: "Tier 1 (Lower Power):  1 turns (6 seconds)",
    description: "Repulsion Field.",
}, {
    name: "Tier 2 (Moderate Power):  3 turns (18 seconds)",
    description: "Artillery Cannon, Flamethrower.",
}, {
    name: "Tier 3 (Higher Power): 1 per encounter",
    description: "Healing Field: 1 per encounter",
}, {
    name: "Scout mode",
    description: "you can turn the Arcane Construct into a scout. It loses its ability to use actions and bonus actions, however it is able to stealth around and be attached to other players, acting as a monitor on what is going on. Because of having enhanced senses, it grants advantage on perception checks when attached to someone.",
}],
  attacks: [{
      name: "Flamethrower",
      damage: [2, 8, "fire"],
      range: "15-ft cone",
      ability: 2,
      dc: true,
      abilitytodamage: false,
      description: "Dex save, DC 14, range 15 ft cone, 2d8 fire damage (save for half)",
      minlevel: 3,
      calcChanges: {
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 5) {fields.Description += ' 3d8 fire damage'; }"],
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 9) {fields.Description += ' 4d8 fire damage'; }"],
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 15) {fields.Description += ' 5d8 fire damage'; }"],
      }
    },
    {
      name: "Force Ballista",
      description: "Ranged spell attack, range 120 ft, +6 to hit, 2d8 force damage, pushes target 5 ft",
      damage: [2, 8, "force"],
      range: "120 ft",
      ability: 5,
      minlevel: 3,
			useSpellMod : "artificer",
      calcChanges: {
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 5) {fields.Description += ' 2d8 +5 force damage'; }"],
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 9) {fields.Description += ' 3d8 + 5 force damage'; }"],
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 15) {fields.Description += ' 4d8 +5 force damage'; }"],
      }
    },
    {
      name: "Artillery Cannon",
      damage: [2, 6, "force"],
      range: "60/240 ft",
      ability: 2,
      dc: true,
      abilitytodamage: false,
      description: "Ranged spell attack, range 60/240 ft, +6 to hit, 2d6 force damage, 10-ft radius",
      minlevel: 3,
      calcChanges: {
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 5) {fields.Description += ' 3d6 force damage'; }"],
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 9) {fields.Description += ' 4d6 force damage'; }"],
        atkAdd: ["if (classes.known.artificer && classes.known.artificer.level >= 15) {fields.Description += ' 5d6 force damage'; }"],
      }
    }
  ]
};

// Adding spells for evolved actions to the spell sheet
SpellsList["evolved flamethrower"] = {
  name: "Evolved Flamethrower",
  classes: ["artificer"],
  source: ["NB2:AM", 1],
  level: 3,
  school: "Evoc",
  time: "1 bns",
  range: "60-ft beam",
  components: "V, S",
  duration: "Instantaneous",
  description: "Dex save, DC 14, range 60 ft beam, 4d8 fire damage (save for half), ignite for 2d8 fire damage per turn until extinguished",
};

SpellsList["evolved force ballista"] = {
  name: "Evolved Force Ballista",
  classes: ["artificer"],
  source: ["NB2:AM", 1],
  level: 3,
  usespellcastingability: true,
  school: "Evoc",
  time: "1 bns",
  range: "120 ft",
  components: "V, S",
  duration: "Instantaneous",
  description: "Ranged spell attack, range 120 ft, +8 to hit, 4d8 force damage plus INT mod, pushes target 10 ft",
};

SpellsList["evolved artillery cannon"] = {
  name: "Evolved Artillery Cannon",
  classes: ["artificer"],
  source: ["NB2:AM", 1],
  level: 5,
  school: "Evoc",
  time: "1 bns",
  range: "60/240 ft",
  components: "V, S",
  duration: "Instantaneous",
  description: "Ranged spell attack, 3 shots, range 60/240 ft, +8 to hit, 5d6 force damage, 30-ft radius",
};

SpellsList["evolved repulsion field"] = {
  name: "Evolved Repulsion Field",
  classes: ["artificer"],
  source: ["NB2:AM", 1],
  level: 4,
  school: "Evoc",
  time: "1 bns",
  range: "Self (20-ft radius)",
  components: "V, S",
  duration: "Instantaneous",
  description: "Str save, DC 14, range 20-ft radius, 4d10 force damage, pushes 20 ft on fail (half damage and no push on success)",
};

SpellsList["evolved healing station"] = {
  name: "Evolved Healing Station",
  classes: ["artificer"],
  source: ["NB2:AM", 1],
  level: 4,
  school: "Conj",
  time: "1 bns",
  range: "Self (10-ft radius)",
  components: "V, S",
  duration: "Instantaneous",
  description: "Restores 4d6 HP to allies within 10-ft radius, revive if dead.",
};

SpellsList["evolved protector"] = {
  name: "Evolved Protector",
  classes: ["artificer"],
  source: ["NB2:AM", 1],
  level: 4,
  school: "Abjur",
  time: "1 bns",
  range: "30 ft",
  components: "V, S",
  duration: "Instantaneous",
  description: "Grants 4d8 + PB temp HP to self and all allies within 30 ft",
};
